---
tag:
 - 系统设计
 - 高可用
---

# 如何保证接口幂等

## 一、接口幂等是什么

在系统设计中，接口幂等是指一个操作或请求无论被执行多少次，其产生的效果与只执行一次相同。

在进行数据操作中，分别存在幂等行与不能保证幂等的，具体如下：

+ √ 满足幂等
+ x 不满足幂等
+ \- 可能满足也可能不满足幂等，根据实际业务逻辑有关

<table>
  <tr>
    <th style="width: 125px;">操作类型</th>
    <th style="width: 125px;">是否幂等</th>
    <th>描述</th>
  </tr>
  <tr>
    <td>插入</td>
    <td>x</td>
    <td>大多数情况下，插入都是不幂等的。</td>
  </tr>
  <tr>
    <td>删除</td>
    <td>-</td>
    <td>在大多数情况下，删除也是幂等的，除了ABA场景。但是在保持接口幂等时可以不考虑删除，因为删除本身目的就是删除该条记录，而不在意期间是否插入相同记录。同时，ABA出现可能性极低，以及解决ABA问题通常需要额外机制，该行为会增加系统的复杂度和额外开销。</td>
  </tr>
  <tr>
    <td>更新</td>
    <td>-</td>
    <td>在幂等上，更新与删除操作类似。但是要额外注意下类似 <code>update table set a = a + 1 where v = 1</code> 操作，会导致不幂等。</td>
  </tr>
  <tr>
    <td>查找</td>
    <td>√</td>
    <td>查找是天生幂等的。</td>
  </tr>
</table>


在实际开发中，以下场景会产生重复请求：

- **用户不可靠**：用户通过客户端发起请求，由于手抖或有意重复点击，很容易造成导致极短时间内发起多次重复请求。如用户重复操作、用户恶意攻击。
- **网络不可靠**：网络抖动、网关内部抖动有可能触发重试机制，这个在使用消息队列投递消息时经常会遇到。如网络波动、超时重试。
- **服务不可靠**：在需要保证数据一致性的场景中，如果调用下游服务超时，在无法确认执行结果的情况下，常用的处理方法是重试。如消息重复消费、响应速度慢。

## 二、为什么要保证接口幂等

保证接口幂等优点如下：

+ 避免数据不一致。
+ 提高系统健壮性：减少由于重复请求导致的错误。
+ 增强用户体验：如不会让用户出现已经付钱了，但还要用户付钱的情况。
+ 减少资源浪费：如避免重复的数据库写入操作。

保证接口幂等缺点如下：

+ 把并行执行的功能改为串行执行，降低了执行效率。

+ 增加了额外控制幂等的业务逻辑，复杂化了业务功能。

保证接口幂等的优点很显著，但缺点影响尽可能降低。所以在使用时候需要考虑是否引入幂等性的必要性，根据实际业务场景具体分析，除了业务上的特殊要求外，一般情况下不需要引入的接口幂等性。

## 三、如何保证接口幂等

保证接口幂等方法核心都是添加唯一性标识符，这个唯一性标识符被称为幂等号。

幂等号有三个关键特性：唯一性、不变性和传递性。

### （一）悲观锁

JDK提供的`ReentrantLock`类、`synchronized`关键字可实现。但是JDK提供的锁都是本地锁，无法在分布式环境下使用。

数据库本身有排他锁（X 锁，也称写锁/独占锁）。排他锁只能在支持事务的存储引擎（如 InnoDB）中使用，且只能在事务中使用。排他锁只能在有索引的字段上使用，否则会锁住整个表，影响并发性能。

高并发的场景下，会出现激烈的锁竞争关系造成线程阻塞，大量阻塞线程频繁切换上下文，增加系统开销。并且，悲观锁还存在死锁问题，影响代码正常运行。

### （二）乐观锁

乐观锁一般会使用版本号机制或CAS算法实现。

高并发的场景下，如果冲突频繁（写占比非常多的情况下）发生，会频繁失败和重试（悲观锁的开销是固定的），这样同样非常影响性能，导致CPU飙升。

乐观锁只适用于更新操作的幂等。

### （三）唯一索引

通过在表中加唯一索引，保证数据的唯一性。

唯一索引只适用于插入操作的幂等。

### （四）去重表

去重表本质也是一种唯一索引方案。去重表是一张专门记录请求信息的表，其中某个字段需要建立唯一索引，用于表示请求的唯一性。

### （五）分布式锁

分布式系统不同的服务/客户端通常运行在独立的JVM进程上，需要使用分布式锁。

分布锁通常使用Redis或Zookeeper实现，MySQL也可以实现但不推荐。

### （六）token机制

Token机制的核心思想是为每一次操作生成一个唯一性的凭证 token。这个 token 需要由服务端生成，因为服务端可以对token进行签名和加密，防止篡改和泄露。如果由客户端生成token，可能会存在安全隐患，比如客户端伪造或重复token，导致服务端无法识别和校验。

### （七）状态机

在许多业务单据中，存在有限数量的状态，并且这些状态之间的流转顺序是固定的。如果状态已经处于下一个状态，那么再次应用上一个状态的变更逻辑是不会产生任何效果的，这就确保了有限状态机的幂等性。状态机主要实现更新操作的幂等性。

### （八）insert 前先 query

在进行插入时先查询表中是否存在相同记录，如果存在则直接返回，不存在则继续执行。

### （九）redis的set机制

将特定前缀+前端请求的url+前端请求内容+token作为redis的键，设置一定的过期时间，若在这期间，能匹配上该键，则证明是重复提交。

### （十）前端按钮加限制

为用户连续点击按钮设置等待时间。影响用户的体验。

### （十一）前端本地缓存

在前端请求拦截器中，设置缓存，缓存请求的url+请求内容+请求时间。每次请求，比较该请求url与缓存的请求url是否相同，请求内容与缓存的请求内容是否相同，比较请求的当前时间与缓存的请求时间是否在不可允许的范围内，若以上都为真，则认为该次请求为重复请求。